name: Clean old deployments
on:
  workflow_dispatch:

permissions:
  contents: read
  deployments: write
  pages: write
  actions: write
  
jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Delete old deployments
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              // Get all deployments
              const { data: deployments } = await github.rest.repos.listDeployments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              
              console.log(`Found ${deployments.length} deployments`);
              
              // Keep only the latest 3 deployments
              const deploymentsToDelete = deployments.slice(3);
              console.log(`Will delete ${deploymentsToDelete.length} deployments`);
              
              for (const deployment of deploymentsToDelete) {
                try {
                  // First, get deployment statuses
                  const { data: statuses } = await github.rest.repos.listDeploymentStatuses({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    deployment_id: deployment.id
                  });
                  
                  // Set deployment to inactive first
                  if (statuses.length > 0) {
                    await github.rest.repos.createDeploymentStatus({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      deployment_id: deployment.id,
                      state: 'inactive'
                    });
                  }
                  
                  // Then delete the deployment
                  await github.rest.repos.deleteDeployment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    deployment_id: deployment.id
                  });
                  
                  console.log(`Deleted deployment ${deployment.id}`);
                } catch (error) {
                  console.log(`Could not delete deployment ${deployment.id}: ${error.message}`);
                }
              }
              
              console.log('Cleanup completed!');
              
            } catch (error) {
              console.error('Cleanup failed:', error.message);
              core.setFailed(`Cleanup failed: ${error.message}`);
            }